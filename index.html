<html>
    <head>
        <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
        <link rel="stylesheet" href="/lib/bootstrap.min.css"></script>
        <script type="text/javascript" src="/lib/jquery.min.js"></script>
        <script type="text/javascript" src="/lib/knockout-min.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h3>Create qoute</h3>
                    <form data-bind="submit: saveQuote">
                        <div class="form-group">
                            <label>Quote</label>
                            <input type="text" class="form-control" placeholder="Enter quote" data-bind="value: newQuoteContent">
                        </div>
                        <div class="form-group">
                            <label>Author</label>
                            <select class="form-control" data-bind="options: $root.authors, optionsCaption: 'Choose...', value: newQuoteAuthor, optionsText: 'fullname'"></select>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
                <div class="col-md-6">
                    <h3>Create author</h3>
                    <form data-bind="submit: saveAuthor">
                        <div class="form-group">
                            <label>Firstname</label>
                            <input type="text" class="form-control" placeholder="Enter firstname" data-bind="value: newAuthorFirstname">
                        </div>
                        <div class="form-group">
                            <label>Lastname</label>
                            <input type="text" class="form-control" placeholder="Enter lastname"  data-bind="value: newAuthorLastname">
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>                    
                    </form>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h3>Quotes</h3>
                    <ul class="list-group" data-bind="foreach: quotes, visible: quotes().length > 0">
                        <li class="list-group-item">
                            <p data-bind="text: content">
                            </p>
                            <small data-bind="text: author().fullname()"></small>
                            <button type="button" class="btn btn-link btn-sm pull-right" data-bind="click: $root.deleteQuote">Remove</button>
                        </li>
                    </ul>
                    <small data-bind="visible: quotes().length === 0">No quotes added.</small>
                </div>
                <div class="col-md-6">
                    <h3>Authors</h3>
                    <ul class="list-group" data-bind="foreach: authors, visible: authors().length > 0">
                        <li class="list-group-item">
                            <span data-bind="text: fullname()"></span>
                            <button type="button" class="btn btn-link btn-sm pull-right" data-bind="click: $root.deleteAuthor">Remove</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <script>

            function Quote(data) {
                this.id = data.id;
                this.content = ko.observable(data.content);
                this.author = ko.observable(new Author(data.author));
            }

            function Author(data) {
                this.id = data.id;
                this.firstname = ko.observable(data.firstname);
                this.lastname = ko.observable(data.lastname);
                this.fullname = ko.pureComputed(function() {
                    return this.firstname() + " " + this.lastname();    
                }, this);
            }

            function QuoteserviceViewModel() {
                var self = this;

                self.authors = ko.observableArray([]);
                self.quotes = ko.observableArray([]);

                self.newAuthorFirstname = ko.observable();
                self.newAuthorLastname = ko.observable();

                self.newQuoteContent = ko.observable();
                self.newQuoteAuthor = ko.observable();

                var QUOTE_HOST = "http://localhost:8080/quotes";
                var AUTHOR_HOST = "http://localhost:8080/authors";

                $.getJSON(AUTHOR_HOST + "?sort=desc", function(allData) {
                    var mappedAuthors = $.map(allData, function(authorData) { 
                        return new Author(authorData) 
                    });
                    self.authors(mappedAuthors);
                });

                $.getJSON(QUOTE_HOST + "?sort=desc", function(allData) {
                    var mappedQuotes = $.map(allData, function(quoteData) { 
                        return new Quote(quoteData) 
                    });
                    self.quotes(mappedQuotes);
                });

                self.saveAuthor = function() {
                    var newAuthor = { firstname: self.newAuthorFirstname(), lastname: self.newAuthorLastname() };
                    var location;
                    $.ajax(AUTHOR_HOST, {
                        data: ko.toJSON(newAuthor),
                        type: "post", contentType: "application/json",
                        success: function(data, textStatus, request) {
                            location = request.getResponseHeader("Location");
                            $.getJSON(location, function(authorData) {
                                self.authors.push(new Author(authorData));
//                                self.newAuthorFirstname("");
//                                self.newAuthorLastname("");
                            });
                        }
                    });
                }; 

                self.deleteAuthor = function(author) {
                    $.ajax(AUTHOR_HOST, {
                        data: ko.toJSON(author),
                        type: "delete", contentType: "application/json",
                        success: function(result) {
                            self.authors.remove(author) 
                        }
                    });
                };

                self.saveQuote = function() {
                    var newQuote = { content: self.newQuoteContent(), author: self.newQuoteAuthor() };
                    var location;
                    $.ajax(QUOTE_HOST, {
                        data: ko.toJSON(newQuote),
                        type: "post", contentType: "application/json",
                        success: function(data, textStatus, request){
                            location = request.getResponseHeader("Location");
                            $.getJSON(location, function(quoteData) {
                                self.quotes.push(new Quote(quoteData));
//                                self.newQuoteAuthor("");
//                                self.newQuoteContent("");
                            });
                        }
                    });
                };

                self.deleteQuote = function(quote) {
                    $.ajax(QUOTE_HOST, {
                        data: ko.toJSON(quote),
                        type: "delete", contentType: "application/json",
                        success: function(result) {
                            console.log("delete");
                            console.log(quote);
                            self.quotes.remove(quote);
                        }
                    });
                };
            }

            ko.applyBindings(new QuoteserviceViewModel());

        </script>
    </body>
</html>
